/**
 * AndroidCp SDK（单例）
 * 暴露为 window.AndroidCp，无需 new；提供 create() 创建额外实例
 * @version 1.0.4
 */
(function (global) {
    const SDK_NAME = 'AndroidCp';
    const _loaded = new Set();
    const _loading = new Map();

    class Core {
        constructor() {
            this.isInitialized = false;
            // 安卓环境检测
            this.isAndroid = (!!window.CpsenseAppEvent && typeof window.CpsenseAppEvent.events === 'function');

            this.isMath = true; // 是否对动态脚本追加时间戳，避免缓存

            // 事件处理
            this._eventAds = {
                listeners: {
                    'ready': [],
                    'beforeAd': [],
                    'afterAd': [],
                    'adDismissed': [],
                    'adViewed': [],
                    'ad_error': [],
                    'interstitial': [],
                    'reward': [],
                    'game_score': [],
                    'game_level': [],
                    'level_start': [],
                    'level_end': [],
                    'loading_update': [],
                    'loading_complete': []
                },
                on(eventName, callback) {
                    if (!this.listeners[eventName]) return;
                    if (typeof callback !== 'function') return;
                    this.listeners[eventName].push(callback);

                },
                emit(eventName, ...args) {

                    if (!this.listeners[eventName]) return;
                    this.listeners[eventName].forEach(callback => {
                        try { callback(...args); } catch (e) { console.warn('[adsdk] event callback error', e && e.message); }
                    });
                },
                off(eventName, callback) {
                    if (!this.listeners[eventName]) return;
                    if (!callback) { this.listeners[eventName] = []; return; }
                    this.listeners[eventName] = this.listeners[eventName].filter(cb => cb !== callback);
                }
            }

            this.android_callback = {
                error: () => { },
                beforeAd: () => { },
                afterAd: () => { },
                adViewed: () => { },
                adDismissed: () => { }
            };

            this.interstitialAd = this._showInterstitialAd;
            this.rewardAd = this._showRewardAd;

            // 消息队列系统
            this.adsdklayer = [];
            this._messageCheckInterval = null;
            this._gameTime = 0;
            this._sendingMessages = false;
            // 最大30秒发一次 
            this._maxPushTime = 30;
            this._pushtime = 5; // 默认1秒发一次


            // 用于处理Android广告状态查询的回调
            this._appeventCallback = (messageArray) => {
                // 过滤 callback-only 并严格规范化输入为数组形式的消息
                // 支持入参为 JSON 字符串、单一对象或数组。最终只处理 [{type, value}, ...] 格式
                let parsed = null;
                try {
                    if (typeof messageArray === 'string') {
                        parsed = JSON.parse(messageArray);
                    } else {
                        parsed = messageArray;
                    }
                } catch (e) {
                    // 无法解析则直接忽略
                    console.warn('[adsdk] _appeventCallback: 无法解析回调数据', e && e.message);
                    return;
                }

                // 强制只接收数组
                if (!Array.isArray(parsed)) {
                    // 如果是单个对象则封装为数组，否则忽略
                    if (parsed && typeof parsed === 'object' && parsed.type) {
                        parsed = [parsed];
                    } else {
                        return;
                    }
                }

                // 规范化每一项为 { type, value }，忽略不合规项
                const normalized = [];
                for (const item of parsed) {
                    try {
                        if (!item || typeof item !== 'object') continue;
                        const type = item.type || item.event_type || null;
                        if (!type) continue;
                        const value = (item.value !== undefined) ? item.value : (item.data !== undefined ? item.data : null);
                        normalized.push({ type, value });
                    } catch (e) {
                        // 单条解析错误则跳过该条
                        continue;
                    }
                }

                // 记录日志并分发
                normalized.forEach(message => {
                    let self = this;
                    self.__sdklog3('[GameStatus] 收到', message.type);

                    if (message.type === "set_pushtime" && typeof message.value === "number") {
                        self.updatePushInterval(message.value);
                    }


                    if (message.type === 'click_ad' && message["value"]) {
                        console.log('收到 click_ad 事件', message.value);

                    }

                    try {
                        switch (message.type) {

                            case 'beforeAd':
                                self.req_ad_timeout = false;
                                try { if (self.android_callback && typeof self.android_callback.beforeAd === 'function') self.android_callback.beforeAd(); } catch (_) { }
                                self._eventAds.emit('beforeAd', message.value, 'beforeAd');
                                break;

                            case 'adViewed':
                                self.req_ad_timeout = false;
                                if (message.value === "reward") {
                                    try { if (self.android_callback && typeof self.android_callback.adViewed === 'function') self.android_callback.adViewed(); } catch (_) { }
                                    self._eventAds.emit('adViewed', message.value, 'adViewed');
                                } else {
                                    try { if (self.android_callback && typeof self.android_callback.afterAd === 'function') self.android_callback.afterAd(); } catch (_) { }
                                    self._eventAds.emit('afterAd', message.value, 'afterAd');
                                }
                                break;
                            case 'adDismissed':
                                self.req_ad_timeout = false;
                                try { if (self.android_callback && typeof self.android_callback.adDismissed === 'function') self.android_callback.adDismissed(); } catch (_) { }
                                self._eventAds.emit('adDismissed', message.value, 'adDismissed');
                                break;
                            case 'ad_error':
                                self.req_ad_timeout = false;
                                try { if (self.android_callback && typeof self.android_callback.error === 'function') self.android_callback.error(); } catch (_) { }
                                self._eventAds.emit('ad_error', self.android_type, message.value);
                                break;
                            default:
                            // this._eventAds.emit(message.type, message.value);
                        }
                    } catch (error) {
                        console.warn('[GameStatus] 处理消息失败:', message, error);
                    }
                });

                // 上层已确认（父页面或原生回调触达）后再启动消息轮询，避免在未就绪时立即开始定时发送
            };


            // 原生回调处理
            window.CpsenseAppEventCallBack = (event) => {
                if (this.isAndroid) {
                    try { this._appeventCallback(event) } catch (e) { console.log('message event err', e) }

                }
            };

            // ads事件流程 
            this._eventAds.on('ready', (param1, param2) => {
                this.__sdklog(param1, param2);
            })

            this._eventAds.on('interstitial', (param1) => {

                this.__sdklog(param1, this.adType);

                if (this.appads_on) {
                    this.adsdklayer.push({
                        type: 'interstitial',
                        value: 1
                    })
                    this.checkAndSendMessages();
                }
            })

            this._eventAds.on('reward', (param1) => {

                this.__sdklog(param1, this.adType);

                if (this.appads_on) {
                    this.adsdklayer.push({
                        type: 'reward',
                        value: 1
                    })
                    this.checkAndSendMessages();
                }
            })

            this._eventAds.on('beforeAd', (param1, param2) => {

                this.__sdklog2("*******adevent**********", param1, param2, this.adType);
            })

            this._eventAds.on('adDismissed', (param1) => {

                this.__sdklog2("*******adevent**********", param1, this.adType);

            })

            this._eventAds.on('adViewed', (param1) => {

                this.__sdklog2("*******adevent**********", param1, this.adType);

            })

            this._eventAds.on('afterAd', (param1, param2) => {

                this.__sdklog2("*******adevent**********", param1, param2, this.adType);

            })

            this._eventAds.on('ad_error', (param1, param2) => {

                switch (param2) {
                    case 'timeout':
                    case 'error':
                    case 'frequencyCapped':
                    case 'notReady':
                    case 'invalid':
                    case 'noAdPreloaded':
                    case 'frequencyrewardAd':
                    case 'frequencyinterstitialAd':
                    case 'other':

                        this.adsdklayer.push({
                            type: 'ad_error',
                            value: param2
                        })
                        break;
                    case 'viewed':
                    case 'dismissed':
                        break;
                    default:

                        this.adsdklayer.push({
                            type: 'ad_error',
                            value: param2
                        })
                        break;
                }
                if (param2 !== 'viewed' && param2 !== 'dismissed') {

                    this.__sdklog2("*******adevent**********", param1, param2, this.adType);
                }
            })

            this._eventAds.on('game_score', (data) => {
                // this.__sdklog3("game_score", data)
                this.adsdklayer.push({
                    type: 'game_score',
                    value: data.score
                });
                // this.checkAndSendMessages();//要一秒一次发送
            })

            this._eventAds.on('game_level', (data) => {
                this.__sdklog3("game_level", data)
                this.adsdklayer.push({
                    type: 'game_level',
                    value: data.level
                });
            })

            // 汇总游戏状态
            this._eventAds.on('level_end', (data) => {
                this.__sdklog3("level_end", data)
                this.adsdklayer.push({
                    type: 'level_end',
                    value: data
                })
            })

            this._eventAds.on('loading_update', (data) => {
                this.__sdklog3("loading_update", data)
                this.adsdklayer.push({
                    type: 'loading_update',
                    value: data.progress
                })
            })


            if (this.isAndroid) {
                this.__sdklog('[adsdk] 上层已确认，启动消息轮询');
                this.startMessageCheck();
            }
        }

        get pushtime() {
            return this._pushtime;
        }

        set pushtime(value) {
            const v = Math.max(1, Math.min(Number(value) || 1, this._maxPushTime));
            const oldTime = this._pushtime;
            if (v !== oldTime) {
                this._pushtime = v;
                this.__sdklog('[adsdk] 推送间隔已更新:', this._pushtime, '秒');
                this.updatePushInterval();
            }
        }

        /**
 * 获取推送间隔（毫秒）
 * 限制在1秒到30秒之间
 */
        getPushInterval() {
            let interval = Math.max(1, Math.min(this.pushtime, this._maxPushTime));
            return interval * 1000;
        }

        /**
     * 启动消息队列检查
     * 根据pushtime配置的间隔检查adsdklayer是否有数据，如果有就发送
     */
        startMessageCheck() {
            if (this._messageCheckInterval) {
                clearInterval(this._messageCheckInterval);
            }

            this._messageCheckInterval = setInterval(() => {
                this.checkAndSendMessages();
            }, this.getPushInterval());

            this.__sdklog('[adsdk] 消息队列检查已启动，间隔:', this.getPushInterval() / 1000, '秒');
        }

        checkAndSendMessages() {
            let self = this;

            if (!self.isAndroid) return;

            if (!self.adsdklayer || self.adsdklayer.length === 0) return;

            const pending = self.adsdklayer.slice();

            self.adsdklayer = [];

            // 在发送到原生前进行去重：相同 type 的后者覆盖前者
            // 这可以保证在短时间（例如1秒）内多次上报的 `game_score` 只保留最后一条
            const deduped = self.deduplicateMessages(pending);

            const nativePayload = deduped;

            try {
               
                if (self.isAndroid) {
                    try {
                        window.CpsenseAppEvent.events(JSON.stringify(nativePayload));
                        self.__sdklog('[adsdk] CpsenseAppEvent.events called with', JSON.stringify(nativePayload));
                    } catch (nativeErr) {
                        console.warn('[adsdk] native push failed:', nativeErr);
                    }
                }
            } catch (sendErr) {
                console.warn('[adsdk] send error:', sendErr);
            }


        }


        deduplicateMessages(messages) {
            const messageMap = new Map();

            // 遍历消息，相同type的后面覆盖前面的
            messages.forEach(message => {
                messageMap.set(message.type, message);
            });

            return Array.from(messageMap.values());
        }

        showAd(value) {
            this.__sdklog3('showAd AD:', value);
            let isTimeOut = false
            return new Promise((resolve, reject) => {
                const st_time = setTimeout(() => {
                    clearTimeout(st_time)
                    if (!isTimeOut) {
                        reject('ad timeout');
                    }
                }, 3000)

                if (value === 'reward') {
                    this._showRewardAd({

                        beforeAd() { isTimeOut = true },
                        adDismissed() {
                            isTimeOut = true
                            console.log('Reward Ad dismissed');
                            reject('ad dismissed');
                        },
                        adViewed() {
                            isTimeOut = true
                            console.log('Reward Ad viewed');
                            resolve('success')
                        },
                        error(err) {
                            isTimeOut = true
                            console.log('Reward Ad error:', err);
                            reject(err);
                        }
                    })
                } else {
                    this._showInterstitialAd({
                        beforeAd() { isTimeOut = true },
                        afterAd() {
                            isTimeOut = true
                            console.log('Interstitial Ad finished');
                            resolve('success')

                        },
                        error(err) {
                            isTimeOut = true
                            console.log('Interstitial Ad error:', err);
                            reject(err);
                        }
                    });

                }

            });
        }

        // 插页
        _showInterstitialAd(callback) {
            let self = this;

            //1秒内禁止重复,防抖
            if (self.req_ad_stabilization) {
                if (typeof callback.error === 'function') callback.error("frequencyCapped");
                return;
            }
            self._debounceTimer = setTimeout(() => {
                clearTimeout(self._debounceTimer);
                self.req_ad_stabilization = false;
            }, 1000);

            self.req_ad_stabilization = true;

            self._eventAds.emit('interstitial', "interstitialAd");

            self._timeoutTimer = setTimeout(() => {
                clearTimeout(self._timeoutTimer);
                if (self.req_ad_timeout) {
                    self.is_first = false;
                    self._eventAds.emit('ad_error', "error", "timeout");
                    if (typeof callback.error === 'function') callback.error("timeout");
                }
            }, 8000);

            let now = Date.now();
            if (!self.interstitial_time_start) {
                self.interstitial_time_start = now;
            }

            // 如果超过30秒，重置计数器
            let now_duration = now - self.interstitial_time_start;
            // console.log('now_duration=', now_duration, 'interstitial_time_start=', self.interstitial_time_start);

            if (self.interstitial_requests_count > 1) {

                if (now_duration > 30000) {

                    self.interstitial_time_start = now;
                } else {
                    if (typeof callback.error === 'function') callback.error({ ad_error_type: 'frequencyinterstitialAd' });
                    self._eventAds.emit('ad_error', "frequencyinterstitialAd", 'frequencyinterstitialAd');
                    return false;
                }
            }
            self.interstitial_requests_count++;

            // 请求广告超时
            self.req_ad_timeout = true;

            // ANDROID：设定类型并改用原生调用，避免重复定时器
            self.android_type = 'interstitialAd';
            Object.assign(self.android_callback, {
                error: (callback && callback.error) || (() => { }),
                beforeAd: (callback && callback.beforeAd) || (() => { }),
                afterAd: (callback && callback.afterAd) || (() => { }),
                adViewed: (callback && callback.adViewed) || (() => { }),
                adDismissed: (callback && callback.adDismissed) || (() => { })
            });
            // 通过事件触发调用安卓原生广告

        }

        _debounceTimer_reward = null;
        _timeoutTimer_reward = null;
        // 激励
        _showRewardAd(callback) {
            let self = this;

            if (self.req_ad_stabilization) {
                if (typeof callback.error === 'function') callback.error("frequencyCapped");
                return;
            };

            self._debounceTimer_reward = setTimeout(() => {
                clearTimeout(self._debounceTimer_reward);
                self.req_ad_stabilization = false;
            }, 1000);

            self.req_ad_stabilization = true;

            self._eventAds.emit('reward', "rewardAd");

            self._timeoutTimer_reward = setTimeout(() => {
                clearTimeout(self._timeoutTimer_reward);
                if (self.req_ad_timeout) {
                    self._eventAds.emit('ad_error', "error", "timeout");
                    if (typeof callback.error === 'function') callback.error("timeout");
                }
            }, 8000);

            const now = Date.now();
            if (!self.reward_time_start) {
                self.reward_time_start = now;
            }

            // 如果超过30秒，重置计数器
            let now_duration = now - self.reward_time_start;
            // console.log('now_duration=', now_duration, 'reward_time_start=', self.reward_time_start);
            if (now_duration > 30000) {
                self.reward_time_start = 0;
                self.reward_requests_count = 3;
            }

            // 检查是否超过3次限制
            if (self.reward_requests_count <= 0) {
                if (typeof callback.error === 'function') callback.error({ ad_error_type: 'frequencyrewardAd' });
                self._eventAds.emit('ad_error', "frequencyrewardAd", 'frequencyrewardAd');
                return false;
            }


            self.reward_requests_count--;
            // 请求广告超时
            self.req_ad_timeout = true;

            // ANDROID：设定类型并改用原生调用，避免重复定时器
            this.android_type = 'rewardedAd';
            Object.assign(this.android_callback, {
                error: (callback && callback.error) || (() => { }),
                beforeAd: (callback && callback.beforeAd) || (() => { }),
                afterAd: (callback && callback.afterAd) || (() => { }),
                adViewed: (callback && callback.adViewed) || (() => { }),
                adDismissed: (callback && callback.adDismissed) || (() => { })
            });

        }

        __sdklog(...args) {
            const formatParam = (arg) => {
                if (typeof arg === 'string') return `'${arg}'`;
                if (typeof arg === 'object') return JSON.stringify(arg);
                return String(arg);
            };

            const params = args.map(formatParam).join(' ');

            console.log(
                `%c ***__acp***: ${params}`,

                'background-color: #f9f9f9; ' +
                'border: 2px solid #8e44ad; ' +
                'color: #333; ' +
                'padding: 5px 15px; ' +
                'border-radius: 5px; ' +
                'font-weight: 500; ' +
                'box-shadow: 0 0 5px rgba(142, 68, 173, 0.3);'
            );
        }

        __sdklog2(...args) {
            const formatParam = (arg) => {
                if (typeof arg === 'string') return `'${arg}'`;
                if (typeof arg === 'object') return JSON.stringify(arg);
                return String(arg);
            };

            const params = args.map(formatParam).join(' ');

            console.log(
                `%c ***__acp***: ${params}`,
                'background: linear-gradient(to right, #8e44ad, #ba43ff); ' +
                'color: white; ' +
                'padding: 5px 15px; ' +
                'border-radius: 5px; ' +
                'font-weight: bold; ' +
                'text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);'

            );
        }
        __sdklog3(...args) {
            const formatParam = (arg) => {
                if (typeof arg === 'string') return `'${arg}'`;
                if (typeof arg === 'object') return JSON.stringify(arg);
                return String(arg);
            };

            const params = args.map(formatParam).join(' ');

            console.log(
                `%c ***DOTGTAG***: ${params}`,
                'background: linear-gradient(to right,rgb(68, 173, 166),rgb(4, 170, 173)); ' +
                'color: white; ' +
                'padding: 5px 15px; ' +
                'border-radius: 5px; ' +
                'font-weight: bold; ' +
                'text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);'

            );
        }
        destroy() { this.isInitialized = false; this.readyCallbacks = []; this.eventCallbacks = {}; this.config = {}; console.log('AndroidCp 已销毁'); }
    }

    const api = Object.assign(new Core(), { create: (cfg) => { const inst = new Core(); if (cfg) inst.setConfig(cfg); return inst; } });
    if (!global[SDK_NAME]) global[SDK_NAME] = api;
    try {
        if (!global["__acp"]) global["__acp"] = api;
    } catch (error) {

    }
})(window);
